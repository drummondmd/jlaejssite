<%- include ('partials/header.ejs') %>

<div class="container mt-2">
    <h1 class="h1">Painel de orçamento</h1>
    
</div>
<div class="container">
    <div class="row">
        <div class="col">
            <form>
                <div class="form-group">
                    <input type="text" placeholder="Nome do projeto" class="form-control mb-3">
                    <select id="tipo" class="form-select mb-3">
                        <option >Selecionar Tipo de Estabelecimento</option>
                        <option value="residencial">Residencial</option>
                        <option value="comercial">Comercial</option>
                    </select>
                    <select id="padrao" class="form-select mb-3">
                        <option value="baixo">Baixo padrão</option>
                        <option value="normal" selected>Normal</option>
                        <option value="alto">Alto padrão</option>
                    </select>
                    
                </div>
                <div class="form-group">
                    <p>Grau de Complexidade do projeto:</p>
                    <div>
                        <div class="row">
                            <div class="col">
                                <label for="comp-projeto">Porte do projeto</label>
                                
                                
                            </div>
                            <div class="col">
                                <select name="" id="porte-projeto" class="comp-projeto form-select">
                                    <option value="0.7">Baixo</option>
                                    <option value="1" selected>Normal</option>
                                    <option value="1.3">Alto</option>
                                </select>
                                
                            </div>
                            
                        </div>
                        
                    </div>
                    <div>
                        <label for="prazo-projeto">Indefinição de Prazo</label>
                        <select name="" id="prazo-projeto" class="comp-projeto form-select">
                            <option value="0.7">Baixo</option>
                            <option value="1" selected>Normal</option>
                            <option value="1.3">Alto</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="escopo-projeto">Indefinição de Escopo</label>
                        <select name="" id="escopo-projeto" class="comp-projeto form-select">
                            <option value="0.7">Baixo</option>
                            <option value="1" selected>Normal</option>
                            <option value="1.3">Alto</option>
                        </select>
                    </div>
                    <div>
                        <label for="grau-custo-projeto">Grau de controle de custo</label>
                        <select name="" id="grau-custo-projeto" class="comp-projeto form-select">
                            <option value="0.7">Baixo</option>
                            <option value="1" selected>Normal</option>
                            <option value="1.3">Alto</option>
                        </select>
                    </div>
                    <div>
                        <label for="grau-intervencao-projeto">Grau de intervenção do Cliente</label>
                        <select name="" id="grau-custo-projeto" class="comp-projeto form-select">
                            <option value="0.7">Baixo</option>
                            <option value="1" selected>Normal</option>
                            <option value="1.3">Alto</option>
                        </select>
                    </div>
                    
                    
                </div>
                <div class="form-group">
                    <div id="div-incluir-ambiente mt-2">
                        <div class="row my-2">
                            <div class="col">
                                <label class="form-label" for="amb">Ambientes:</label>
                            </div>
                            <div class="col">
                                <input class="form-control" type="number" id="amb">
                            </div>
                            <div class="col text-center">
                                <button class="btn btn-outline-secondary" id="incl-amb">Incluir</button>
                            </div>
                            
                        </div>
                    </div>
                    
                    
                    
                </div>
                
                
                
                <div id="amb-incluido">
                    
                </div>
                
                
                
                
                
            </form>
            
        </div>
        <div class="col">
            <div>
                <button class="btn btn-outline-primary" id="calc">Calcular Orçamento</button><br>
            </div>
            <div id="result">
                <p>
                    Orçamento aparecerá aqui.
                </p>
                
            </div>
            
            
        </div>
        
    </div>
    
    
</div>



<%- include ('partials/footer.ejs') %>

<script>
    $( document ).ready(function() {
        console.log( "ready!" );
    });
    
    
    $("#incl-amb").on("click",function(){
        event.preventDefault();
        let qnt = $("#amb").val()   
        let html = []
        
        for(let i=0; i<qnt; i++){
            html.push
            (`
            <div class="bg-info-subtle my-3 p-2">
                <div>
                    <input type="text" class="amb-nome form-control mb-1" value="Ambiente-${i+1}">
                    <input type="number" class="amb-m2 form-control mb-1" placeholder="metragem">
                    <div class="row">
                        <div class="col">
                            <label for="descoberto-${i+1} >Area descoberta?</label>
                        </div>
                        <div class="col">
                            <input type="checkbox" id="descoberto-${i+1}" class="amb-descoberto">
                        </div>
                    </div>
                </div>
                <div >
                    <label for="grau-detalhamento-${i+1}">Grau de detalhamento</label>
                    <select name="" id="grau-detalhamento-${i+1}" class="comp-amb-det form-select">
                        <option value="0.7">Baixo</option>
                        <option value="1" selected>Normal</option>
                        <option value="1.3">Alto</option>
                    </select>
                </div>
                <div>
                    <label class="form-label" for="necessidade-aprovacao-${i+1}">Quantidade de aprovações</label>
                    <select name="" id="necessidade-aprovacao-${i+1}" class="comp-amb-aprov form-select">
                        <option value="0.7">Baixo</option>
                        <option value="1" selected>Normal</option>
                        <option value="1.3">Alto</option>
                    </select>
                </div>

            </div>
        `
            
            )
            
            console.log("Amb"+i)
        }
        console.log(html)
        $("#amb-incluido").append(html)
        $("#div-incluir-ambiente").hide()
    })
    
    
    $("#calc").on("click",function(){
        event.preventDefault();
        let tipo = $("#tipo").val()
        let padrao = $("#padrao").val()
        
        //bh
        let bh = cubFunction(tipo,padrao);
        
        //complexidade projeeto
        let compProjetoArray = $(".comp-projeto option:selected").toArray().map(elem => + elem.value)
        let soma = 0 
        for(let i=0 ;i<compProjetoArray.length;i++){
            soma += compProjetoArray[i]
        }
        let compProjeto =soma/5
        
        ///ambientes
        
        let ambientesArray = $(".amb-nome").toArray().map((elem,index) => elem.value)
        let ambientesObj =[]
        
        ambientesArray.forEach((elem,index)=>{
            ambientesObj.push(
            {
                nome: elem,
                metro:+$(".amb-m2").toArray()[index].value,
                descorbeto:$(".amb-descoberto").toArray()[index].value,
                detalhamento:+ $(".comp-amb-det").toArray()[index].value,
                aprovacao:+$(".comp-amb-aprov").toArray()[index].value,
                
            }
            )
            
        })
        
        /// acrescentando fp,preco a cada ambiente
        
        ambientesObj.forEach((elem,index)=>{
            let soma1 = (elem.detalhamento +elem.aprovacao) /2;
            let soma2 = (soma1 +compProjeto)/2;
            elem.complexidade = soma1;
            elem.complexidadeCombinada = soma2;
            let fp =fpFunction (soma2);
            elem.preco = bh*elem.metro*fp 
        })
        console.log(ambientesObj)
        
        ///somando preço de ambientes
        let somaPreco = 0
        
        
        ///printando resultado
        
        html = []
        console.log(ambientesObj)
        ambientesObj.forEach((elem)=>{
            html.push(
            `<p>Valor do ${elem.nome} é: ${elem.preco} </p>
            `
            ) 
        })
        
        //calculo
        // let result =metro*bh*fp
        
        
        //return in paragraph
        
        $("#result").append(html)
        
    })
    
    
    
    let cub ={
        r1B:2193.59,
        r1N:2608.87,
        r1A:3262.18,
        cal8N:2510.98,
        cal8A:2712.08
    }
    
    let cubAjustado = {
        r1B:cub.r1B,
        r1N:cub.r1N*1.5,
        r1A:cub.r1A*2,
        cal8N:cub.cal8N,
        cal8A:cub.cal8A*1.5
        
    }
    
    let fp = {
        baixo:0.0733,
        medio:0.0839,
        alto:0.0961,
        especial:0.11
    }
    
    let ajusteMercado =0.2
    let fpAjustado = {
        baixo:fp.baixo*ajusteMercado,
        medio:fp.medio*ajusteMercado,
        alto:fp.alto*ajusteMercado,
        especial:fp.especial*ajusteMercado
    }
    //fator de ajuste
    
    
    function cubFunction(tipo,padrao){
        let bh = ""
        if (tipo == "residencial") {
            switch(padrao){
                case ("baixo"):
                bh = cubAjustado.r1B
                break;
                case ("normal"):
                bh = cubAjustado.r1N
                break;
                case ("alto"):
                bh = cubAjustado.r1A
                break;
            }
        } else if(tipo == "comercial"){
            switch(padrao){
                case ("normal"):
                bh = cubAjustado.cal8N
                break;
                case ("alto"):
                bh = cubAjustado.cal8A
                break;
            }
            
        }else {
            console.log("erro")
            
        }
        
        return bh
        
    }
    
    console.log(fpFunction(1.15))
    
    
    function fpFunction (complexidade){
        let fp = ""
        if (complexidade <= 0.85) {
            fp = fpAjustado.baixo           
        } else if(complexidade >=0.86 &complexidade<1) {
            fp = fpAjustado.medio
        } else if(complexidade >=1 &complexidade<1.16) {
            fp = fpAjustado.alto
        }else{
            fp = fpAjustado.especial
        }
        // switch (complexidade) {
        //     case <=0.85:
        //         fp = fpAjustado.baixo            
        //         break;
        //         case "medio":
        //         fp = fpAjustado.medio            
        //         break;
        //         case "alto":
        //         fp = fpAjustado.alto            
        //         break;
        //         case "especial":
        //         fp = fpAjustado.especial            
        //         break;
        //     default:
        //         console.log("erro na function do calculo fator percentual")
        //         break;
        // }
        return fp
        
    }
    
    
    
</script>